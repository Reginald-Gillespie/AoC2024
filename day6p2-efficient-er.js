const start = Date.now();

let input =
`.#..#......................#........#........................................#.............#......#...............#...............
.......#...........#........................#..............#.....#......#..##............#.....#.....................##...........
.#.....#........#.##..#.............#...........#................#............#.#.........#.....................#......#..........
...........#...#.#.................................#.....................#............#.....#.#................#..#...............
..................................................................................#...............................................
..................#....................#.................#.........#..#.................#...........#...................#.........
.......#......#................#.......#............................#.................#.........................#...#........#....
................................#..............................................................#.........#.........#..............
.......................................................#............#......#........#.#...................#............#..........
.....#......#..............................................#..............................................#.......................
......#..........................................................................................#................#...............
............................#..................#............#..#.#..............#..........#......................................
......#..........................#...................#..........#....#.........................#.......................#....#..#..
..................................#..........#....................................................................#........#......
..#.................................#..................................................#......................#...................
.....#............#..................#......#...................................#.#........#.#......#........#....................
........#......................#.....#...#.##................................#......#.............................................
...........#.........#...............................................................................#............................
..................................#...##...............................#.............#.........................................##.
..........................#.#..#......................................#........#..............................#...................
......#...........###..#....#........................................................................................#............
..............#.....................................................................#......##.............#.......................
.................................#...................#.........#..............................................#...........#.......
....................#..#...................................................#................................#........#............
........................................#.#.#..................#....................#.....#.................#.....................
.........................#....#.....#.................##...............................................#.......#...#..............
..#.........................#....................#.........................#..............................#...................#...
..................##....#..#..#.#.................................................................#...............................
..............#........................................................#.............................#......#.....................
.................#...........#........................#......#..........##....................#.................................#.
..........................#.............................................#..#.................................#.........#...#......
..#..................##.....................................................#.....................#.......#.....#.................
....#.........................................#..................#.#.........................#.......................#............
...#.....#.#..............................................................#................#......................#...#........#..
.............................#..#......#.....................................................##...................................
...........#......................#....#.........#........................#......................................................#
............#.............................................#.................................#....#................................
..............................................................#.............#................#.........#.........................#
..........................................#....#........#......................#.....#.............#..............................
..#..#.............#...............................................#.....................................................#........
................................................................................#.............#...................................
...............................................#.......................#................#............#....................#.#.....
.......................#.............................#.#..................#...#....#.................................#...#.....#..
.......................#...........................#.........................................#.........#.........................#
...#.........#.....#..........................................#...................................................................
..........#..#...#...#........................#..........#..........................................#......#.........#............
...............#............................#.#...................##.....................................................#........
.........................................................#....................#........................#.........#....##....#...#.
......................................#.#................................................#........................#...............
..........#.............................................................#..#..#..............................#...#...#.#..........
.........#.....................................................................................#...........#..#......#..........#.
............................#....................#..............#...#.............................................................
...........................................................#........#......................#.................................#....
.........#..................#.........#.......#...............................#................#.............#...........#........
............................#.........#...........................................................................................
................................#...........#.......................................#..........#.#.....#..........................
..........................................#.................................................................................#.....
..............#...............................................#...................................................................
...#....#.....................#..........#..#......................#..............................................................
.......................#..........#.................................................#......#.............#........#....#..........
.........................................................................#.#......................................#...............
..........................................#.......................#...............................................#.........#...#.
............................#.......................................................#...#.........#..#...##........#..............
...........................................................................#..............#..........#.............#..............
#............#..#...#..#........#....................#...........#..#.........................................#..........#........
...........................................................................#......#..^.........#.........#........................
......#............................#.............................................................................................#
......................#.....#.......................................................#........................#..........#.........
................#....#.......#.............................#..............#....................#....#....................#........
......#...................................#..................................................................#....................
.....#..............#.#...........................................................#.................#.........#......#........#...
..#..#..#..#........#...........#...........#....##...........#.....................#.............................................
......................##..........................................................................................................
...........#............#.........................................................#.....#.....#....................#..............
#.............#..........#...............#..#.......................................#..............................#..............
#.......................................#........#....#.......................................................#..#.............#..
.......................#...#.....#..#...........................#...........#.........................#...#...#................#..
#...............................................................#........................................#.....................#..
..#.....................#............................##..........#..................##...#.....................................#..
.......#...................##..........................................#........#.................................................
.........................................................#............................................#...............##..........
.......................#......#..............................................................................................#....
...........#.......................................#.................................#..........#.............#..................#
....#.............#......#............................#........................#...................#......#.....#..........#......
.................................................................#................................#...............................
..........................................................#.......................#...#...........................................
.#............#...........................................#............................#..............................#...#.#.....
..#.................................................#.............................................#.....................#.........
.....#...............#...#.......................#.......................#......................................#...........#.....
...........#...#................................#.............................#........#.........................................#
..............................#.....................#......................#...#................................#.................
.........#.....................................................#...#......................................#................#......
.....#.....................#.................................#...................................................#....#......#....
................#.........#.........................#...........#...#..............................................#..............
.................................#....................................................................#..................#......#.
#..............#......................................................................#.....#.....................................
.............#......#..............##.#............#.#.....................#..........#.......#..........................#........
.......#............#.................#...........................................................#.............................#.
...........................#.......................#..................#....#....................................#.................
....#.....##...........................................#...........#.............#........................#.....#.................
............................#..............................................##..........#..................#.......#...............
#.............................#.............#...............................#..........#...#.....................................#
.............#.......#.....................................#...###......##...............#..#..............#.........#............
.......#......##.....#..................#....................................#............#................#...................#..
..............#......................#............#........#.....................................................#.........#....#.
.............#.......#...............................................##......#...........#...........#............................
#.#....#..............................................................#.........................................#...............#.
...#....#........................#.#.......#.....................#.............................#.#......................#.#.......
.##........................................................#.#...................#.....#.................................#........
............................#.#..................................#....#...........................................................
..................................................#......#...............#...............................#..#..#.......#..........
..........#......................#..........#.........................#...............#..##.....................#.................
...#.......#.........................................................#............#.........#...#................................#
....................#...................................#..........#.....#...#..#........#............#................#..........
...............................#........#.....................................#.....................................#.........#...
....#....................#...................................#.#........................#.........................................
.........#............................#.....................#.............#...........##.........#................................
.............................................##........................................#......#................................#..
...#...............................#.#...#...........#.............................#.............................................#
.............................#...........#................#..................................................#............#.......
................#....................................................................................#..#.#.......................
...#.............#.#..#.......................#.................#...............#..#....#..............#............#......#......
...........#......#............................#.....#..........#.#.................#..........#...........#...............#...#..
....#..................#...........................#.........#............#........#..........#..............................#....
..........#.......#...................#......#.......#.......#....................#.....................................#.........
...#....................................................#......#...#...................#.....................#....................
....................#..#.....#......#...................#............#.......................................#...............#....
.........................#.......#.....#..#.......#...........#......##..............................#.........#..................
.#...........#...#.........#....#...#.......#....#........................#...................#...#..................#............
.........##......#..............................#....................#..#...#..................#............................#.....`



let key = {
    "." : 0,
    "#" : 1,
    "X" : 3,
    "O" : 4,
    "^" : 9,
}

function getCoord(arr, target) {
    for (let y = 0; y < arr.length; y++) {
        const x = arr[y].indexOf(target);
        if (x !== -1) return [ x, y ];
    }
    return null;
}

function incrementDirection(currentDirection) {
    // This rotates the dirrection to be going to the right
    return [-1*currentDirection[1], currentDirection[0]]
}


function deepClone(input) {
    return input.map(row => row.map(cell => 
        Array.isArray(cell) ? [...cell] : cell
    ));
}

function runGuard(input, obstructionPos=null) {
    // Reset variables for this upcoming run
    let guardLocation = getCoord(input, 9);
    let direction = [0, -1]
    let runInput = deepClone(input);

    // Now, assume we placed an object on xPos,yPos
    if (obstructionPos) runInput[obstructionPos[1]][obstructionPos[0]] = key["#"]

    let createsLoop = false;

    while (true) {
        const nextPossibleLocation = [guardLocation[0]+direction[0], guardLocation[1]+direction[1]]
        let nextPossibleCell = runInput?.[nextPossibleLocation[1]]?.[nextPossibleLocation[0]]

        // Exit loop when the guard exits
        if (nextPossibleCell === undefined || nextPossibleCell === null) 
            break;

        // Check if we've hit a loop on the square we're on rn
        const thisSquare = runInput?.[guardLocation[1]]?.[guardLocation[0]];
        if (typeof(thisSquare) == "object") {
            // Check if we've been on this cell going this direction before
            for (var i = 0; i < thisSquare.length; i++) {
                const thisDirection = thisSquare[i];
                if (thisDirection[0] == direction[0] && thisDirection[1] == direction[1]) {
                    // We've been this exact direction on this exact square before, therefore it is a loop
                    createsLoop = true;
                    break
                }
            }
        }
        
        // Easier type-checking of cell
        if (typeof(nextPossibleCell) == "object") {
            // Mark as just generally visited without metadata for easier checking
            nextPossibleCell = key["X"];
        }

        if (createsLoop) 
            break;

        switch (nextPossibleCell) {
            case key["."]:
            case key["X"]:
                // Mark as visited
                if (typeof(runInput[guardLocation[1]][guardLocation[0]]) !== "object") 
                    runInput[guardLocation[1]][guardLocation[0]] = []
                
                runInput[guardLocation[1]][guardLocation[0]].push(direction);

                // Mark and move up guard pos
                guardLocation = nextPossibleLocation;
                break

            case key["#"]:
                // Can't move, rotate
                direction = incrementDirection(direction)
                break
        }
    }

    runInput[guardLocation[1]][guardLocation[0]] = [] // mark this as position guard has been at

    return [createsLoop, runInput]
}

// Parse input
let parsedInput = input.trim().split("\n").map(p => p.split("").map(c => key[c]))

// First, we'll collect all the squares it travels on as possible obstructions
const [_, normalPath] = runGuard(parsedInput);
let possibleObstructions = [];
normalPath.forEach((row, rowIndex) => {
    row.forEach((cell, cellIndex) => {
        if (typeof(cell) == "object") possibleObstructions.push([cellIndex, rowIndex]);
    })
})

// Stats
let loopCount = 0;

// Loop through all places that could redirect the guard
for (let i = 0; i < possibleObstructions.length; i++) {
    const obstruction = possibleObstructions[i];
    const [createsLoop] = runGuard(parsedInput, obstruction);

    if (createsLoop) {
        loopCount++;
    }
}

const end = Date.now();
console.log(`Took ${(end-start)/1000} seconds`)
console.log(`Num loops: ${loopCount}`)
